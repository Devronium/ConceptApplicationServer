import standard.lib.str
import standard.lang.serialize

define UTABLE_ISO8859_1 [ ]
define UTABLE_ISO8859_2	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "260": 161, "728": 162, "321": 163, "164": 164, "317": 165, "346": 166, "167": 167, "168": 168, "352": 169, "350": 170, "356": 171, "377": 172, "173": 173, "381": 174, "379": 175, "176": 176, "261": 177, "731": 178, "322": 179, "180": 180, "318": 181, "347": 182, "711": 183, "184": 184, "353": 185, "351": 186, "357": 187, "378": 188, "733": 189, "382": 190, "380": 191, "340": 192, "193": 193, "194": 194, "258": 195, "196": 196, "313": 197, "262": 198, "199": 199, "268": 200, "201": 201, "280": 202, "203": 203, "282": 204, "205": 205, "206": 206, "270": 207, "272": 208, "323": 209, "327": 210, "211": 211, "212": 212, "336": 213, "214": 214, "215": 215, "344": 216, "366": 217, "218": 218, "368": 219, "220": 220, "221": 221, "354": 222, "223": 223, "341": 224, "225": 225, "226": 226, "259": 227, "228": 228, "314": 229, "263": 230, "231": 231, "269": 232, "233": 233, "281": 234, "235": 235, "283": 236, "237": 237, "238": 238, "271": 239, "273": 240, "324": 241, "328": 242, "243": 243, "244": 244, "337": 245, "246": 246, "247": 247, "345": 248, "367": 249, "250": 250, "369": 251, "252": 252, "253": 253, "355": 254, "729": 255]
define UTABLE_ISO8859_3	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "294": 161, "728": 162, "163": 163, "164": 164, "292": 166, "167": 167, "168": 168, "304": 169, "350": 170, "286": 171, "308": 172, "173": 173, "379": 175, "176": 176, "295": 177, "178": 178, "179": 179, "180": 180, "181": 181, "293": 182, "183": 183, "184": 184, "305": 185, "351": 186, "287": 187, "309": 188, "189": 189, "380": 191, "192": 192, "193": 193, "194": 194, "196": 196, "266": 197, "264": 198, "199": 199, "200": 200, "201": 201, "202": 202, "203": 203, "204": 204, "205": 205, "206": 206, "207": 207, "209": 209, "210": 210, "211": 211, "212": 212, "288": 213, "214": 214, "215": 215, "284": 216, "217": 217, "218": 218, "219": 219, "220": 220, "364": 221, "348": 222, "223": 223, "224": 224, "225": 225, "226": 226, "228": 228, "267": 229, "265": 230, "231": 231, "232": 232, "233": 233, "234": 234, "235": 235, "236": 236, "237": 237, "238": 238, "239": 239, "241": 241, "242": 242, "243": 243, "244": 244, "289": 245, "246": 246, "247": 247, "285": 248, "249": 249, "250": 250, "251": 251, "252": 252, "365": 253, "349": 254, "729": 255]
define UTABLE_ISO8859_4	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "260": 161, "312": 162, "342": 163, "164": 164, "296": 165, "315": 166, "167": 167, "168": 168, "352": 169, "274": 170, "290": 171, "358": 172, "173": 173, "381": 174, "175": 175, "176": 176, "261": 177, "731": 178, "343": 179, "180": 180, "297": 181, "316": 182, "711": 183, "184": 184, "353": 185, "275": 186, "291": 187, "359": 188, "330": 189, "382": 190, "331": 191, "256": 192, "193": 193, "194": 194, "195": 195, "196": 196, "197": 197, "198": 198, "302": 199, "268": 200, "201": 201, "280": 202, "203": 203, "278": 204, "205": 205, "206": 206, "298": 207, "272": 208, "325": 209, "332": 210, "310": 211, "212": 212, "213": 213, "214": 214, "215": 215, "216": 216, "370": 217, "218": 218, "219": 219, "220": 220, "360": 221, "362": 222, "223": 223, "257": 224, "225": 225, "226": 226, "227": 227, "228": 228, "229": 229, "230": 230, "303": 231, "269": 232, "233": 233, "281": 234, "235": 235, "279": 236, "237": 237, "238": 238, "299": 239, "273": 240, "326": 241, "333": 242, "311": 243, "244": 244, "245": 245, "246": 246, "247": 247, "248": 248, "371": 249, "250": 250, "251": 251, "252": 252, "361": 253, "363": 254, "729": 255]
define UTABLE_ISO8859_5	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "1025": 161, "1026": 162, "1027": 163, "1028": 164, "1029": 165, "1030": 166, "1031": 167, "1032": 168, "1033": 169, "1034": 170, "1035": 171, "1036": 172, "173": 173, "1038": 174, "1039": 175, "1040": 176, "1041": 177, "1042": 178, "1043": 179, "1044": 180, "1045": 181, "1046": 182, "1047": 183, "1048": 184, "1049": 185, "1050": 186, "1051": 187, "1052": 188, "1053": 189, "1054": 190, "1055": 191, "1056": 192, "1057": 193, "1058": 194, "1059": 195, "1060": 196, "1061": 197, "1062": 198, "1063": 199, "1064": 200, "1065": 201, "1066": 202, "1067": 203, "1068": 204, "1069": 205, "1070": 206, "1071": 207, "1072": 208, "1073": 209, "1074": 210, "1075": 211, "1076": 212, "1077": 213, "1078": 214, "1079": 215, "1080": 216, "1081": 217, "1082": 218, "1083": 219, "1084": 220, "1085": 221, "1086": 222, "1087": 223, "1088": 224, "1089": 225, "1090": 226, "1091": 227, "1092": 228, "1093": 229, "1094": 230, "1095": 231, "1096": 232, "1097": 233, "1098": 234, "1099": 235, "1100": 236, "1101": 237, "1102": 238, "1103": 239, "8470": 240, "1105": 241, "1106": 242, "1107": 243, "1108": 244, "1109": 245, "1110": 246, "1111": 247, "1112": 248, "1113": 249, "1114": 250, "1115": 251, "1116": 252, "167": 253, "1118": 254, "1119": 255]
define UTABLE_ISO8859_6	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "164": 164, "1548": 172, "173": 173, "1563": 187, "1567": 191, "1569": 193, "1570": 194, "1571": 195, "1572": 196, "1573": 197, "1574": 198, "1575": 199, "1576": 200, "1577": 201, "1578": 202, "1579": 203, "1580": 204, "1581": 205, "1582": 206, "1583": 207, "1584": 208, "1585": 209, "1586": 210, "1587": 211, "1588": 212, "1589": 213, "1590": 214, "1591": 215, "1592": 216, "1593": 217, "1594": 218, "1600": 224, "1601": 225, "1602": 226, "1603": 227, "1604": 228, "1605": 229, "1606": 230, "1607": 231, "1608": 232, "1609": 233, "1610": 234, "1611": 235, "1612": 236, "1613": 237, "1614": 238, "1615": 239, "1616": 240, "1617": 241, "1618": 242]
define UTABLE_ISO8859_7	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "8216": 161, "8217": 162, "163": 163, "8364": 164, "8367": 165, "166": 166, "167": 167, "168": 168, "169": 169, "890": 170, "171": 171, "172": 172, "173": 173, "8213": 175, "176": 176, "177": 177, "178": 178, "179": 179, "900": 180, "901": 181, "902": 182, "183": 183, "904": 184, "905": 185, "906": 186, "187": 187, "908": 188, "189": 189, "910": 190, "911": 191, "912": 192, "913": 193, "914": 194, "915": 195, "916": 196, "917": 197, "918": 198, "919": 199, "920": 200, "921": 201, "922": 202, "923": 203, "924": 204, "925": 205, "926": 206, "927": 207, "928": 208, "929": 209, "931": 211, "932": 212, "933": 213, "934": 214, "935": 215, "936": 216, "937": 217, "938": 218, "939": 219, "940": 220, "941": 221, "942": 222, "943": 223, "944": 224, "945": 225, "946": 226, "947": 227, "948": 228, "949": 229, "950": 230, "951": 231, "952": 232, "953": 233, "954": 234, "955": 235, "956": 236, "957": 237, "958": 238, "959": 239, "960": 240, "961": 241, "962": 242, "963": 243, "964": 244, "965": 245, "966": 246, "967": 247, "968": 248, "969": 249, "970": 250, "971": 251, "972": 252, "973": 253, "974": 254]
define UTABLE_ISO8859_8	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "162": 162, "163": 163, "164": 164, "165": 165, "166": 166, "167": 167, "168": 168, "169": 169, "215": 170, "171": 171, "172": 172, "173": 173, "174": 174, "175": 175, "176": 176, "177": 177, "178": 178, "179": 179, "180": 180, "181": 181, "182": 182, "183": 183, "184": 184, "185": 185, "247": 186, "187": 187, "188": 188, "189": 189, "190": 190, "8215": 223, "1488": 224, "1489": 225, "1490": 226, "1491": 227, "1492": 228, "1493": 229, "1494": 230, "1495": 231, "1496": 232, "1497": 233, "1498": 234, "1499": 235, "1500": 236, "1501": 237, "1502": 238, "1503": 239, "1504": 240, "1505": 241, "1506": 242, "1507": 243, "1508": 244, "1509": 245, "1510": 246, "1511": 247, "1512": 248, "1513": 249, "1514": 250, "8206": 253, "8207": 254]
define UTABLE_ISO8859_9	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "161": 161, "162": 162, "163": 163, "164": 164, "165": 165, "166": 166, "167": 167, "168": 168, "169": 169, "170": 170, "171": 171, "172": 172, "173": 173, "174": 174, "175": 175, "176": 176, "177": 177, "178": 178, "179": 179, "180": 180, "181": 181, "182": 182, "183": 183, "184": 184, "185": 185, "186": 186, "187": 187, "188": 188, "189": 189, "190": 190, "191": 191, "192": 192, "193": 193, "194": 194, "195": 195, "196": 196, "197": 197, "198": 198, "199": 199, "200": 200, "201": 201, "202": 202, "203": 203, "204": 204, "205": 205, "206": 206, "207": 207, "286": 208, "209": 209, "210": 210, "211": 211, "212": 212, "213": 213, "214": 214, "215": 215, "216": 216, "217": 217, "218": 218, "219": 219, "220": 220, "304": 221, "350": 222, "223": 223, "224": 224, "225": 225, "226": 226, "227": 227, "228": 228, "229": 229, "230": 230, "231": 231, "232": 232, "233": 233, "234": 234, "235": 235, "236": 236, "237": 237, "238": 238, "239": 239, "287": 240, "241": 241, "242": 242, "243": 243, "244": 244, "245": 245, "246": 246, "247": 247, "248": 248, "249": 249, "250": 250, "251": 251, "252": 252, "305": 253, "351": 254, "255": 255]
define UTABLE_ISO8859_10	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "260": 161, "274": 162, "290": 163, "298": 164, "296": 165, "310": 166, "167": 167, "315": 168, "272": 169, "352": 170, "358": 171, "381": 172, "173": 173, "362": 174, "330": 175, "176": 176, "261": 177, "275": 178, "291": 179, "299": 180, "297": 181, "311": 182, "183": 183, "316": 184, "273": 185, "353": 186, "359": 187, "382": 188, "8213": 189, "363": 190, "331": 191, "256": 192, "193": 193, "194": 194, "195": 195, "196": 196, "197": 197, "198": 198, "302": 199, "268": 200, "201": 201, "280": 202, "203": 203, "278": 204, "205": 205, "206": 206, "207": 207, "208": 208, "325": 209, "332": 210, "211": 211, "212": 212, "213": 213, "214": 214, "360": 215, "216": 216, "370": 217, "218": 218, "219": 219, "220": 220, "221": 221, "222": 222, "223": 223, "257": 224, "225": 225, "226": 226, "227": 227, "228": 228, "229": 229, "230": 230, "303": 231, "269": 232, "233": 233, "281": 234, "235": 235, "279": 236, "237": 237, "238": 238, "239": 239, "240": 240, "326": 241, "333": 242, "243": 243, "244": 244, "245": 245, "246": 246, "361": 247, "248": 248, "371": 249, "250": 250, "251": 251, "252": 252, "253": 253, "254": 254, "312": 255]
define UTABLE_ISO8859_16	["128": 128, "129": 129, "130": 130, "131": 131, "132": 132, "133": 133, "134": 134, "135": 135, "136": 136, "137": 137, "138": 138, "139": 139, "140": 140, "141": 141, "142": 142, "143": 143, "144": 144, "145": 145, "146": 146, "147": 147, "148": 148, "149": 149, "150": 150, "151": 151, "152": 152, "153": 153, "154": 154, "155": 155, "156": 156, "157": 157, "158": 158, "159": 159, "160": 160, "260": 161, "261": 162, "321": 163, "8364": 164, "8222": 165, "352": 166, "167": 167, "353": 168, "169": 169, "536": 170, "171": 171, "377": 172, "173": 173, "378": 174, "379": 175, "176": 176, "177": 177, "268": 178, "322": 179, "381": 180, "8221": 181, "182": 182, "183": 183, "382": 184, "269": 185, "537": 186, "187": 187, "338": 188, "339": 189, "376": 190, "380": 191, "192": 192, "193": 193, "194": 194, "258": 195, "196": 196, "262": 197, "198": 198, "199": 199, "200": 200, "201": 201, "202": 202, "203": 203, "204": 204, "205": 205, "206": 206, "207": 207, "272": 208, "323": 209, "210": 210, "211": 211, "212": 212, "336": 213, "214": 214, "346": 215, "368": 216, "217": 217, "218": 218, "219": 219, "220": 220, "280": 221, "538": 222, "223": 223, "224": 224, "225": 225, "226": 226, "259": 227, "228": 228, "263": 229, "230": 230, "231": 231, "232": 232, "233": 233, "234": 234, "235": 235, "236": 236, "237": 237, "238": 238, "239": 239, "273": 240, "324": 241, "242": 242, "243": 243, "244": 244, "337": 245, "246": 246, "347": 247, "369": 248, "249": 249, "250": 250, "251": 251, "252": 252, "281": 253, "539": 254, "255": 255]

class Charset {
	static parse(charset_table) {
		var[] charset;
		var arr = StrSplit(StrReplace(charset_table, "\t", " "), "\n");
		for (var i = 0; i < length arr; i++) {
			var line = trim(arr[i]);
			if ((line) && (line[0] != "#")) {
				var arr2 = StrSplit(line, " ");
				var c = arr2[0];
				var u = arr2[1];
				if ((c) && (u)) {
					c = ToLower(c);
					u = ToLower(u);
					if (c[0] + c[1] == "0x")
						c = SubStr(c, 2);
					if (u[0] + u[1] == "0x")
						u = SubStr(u, 2);

					var n = HexToNumber(c);
					var n2 = HexToNumber(u);
					if ((n == n2) && (n <= 0x7F))
						continue;

					charset["" + n2] = chr(n);
				}
			}
		}
		return charset;
	}

	static embed(array, hex = false) {
		var data = "";
		var keys = GetKeys(array);
		for (var i = 0; i < length keys; i++) {
			var k = keys[i];
			if (k) {
				if (data)
					data += ", ";
				var k2 = k;
				if (hex)
					k2 = NumberToHex(value k);
				data += "\"$k2\": ";
				var replace = unpack("u8", array[k])[0];
				if (hex)
					replace = "\"" + NumberToHex(replace) + "\"";
				data += replace;
			}
		}
		if (data)
			data = "[$data]";
		return data;
	}

	static convert(var str, vector) {
		var latin_str = "";
		var len = UTF8Length(str);
		var index = 0;
		while (len) {
			var prec_index = index;
			var c = UTF8NextChar(str, index);
			if (c <= 0x7F) {
				latin_str += chr(c);
			} else {
				var key = "" + c;
				if (IsSet(vector, key))
					latin_str += chr(vector[key]);
				else
				if ((!vector) && (c <= 0xFF))
					latin_str += chr(c);
			}
			
			len--;
		}
		return latin_str;
	}

	static latin1(str) {
		return Charset::convert(str, UTABLE_ISO8859_1);
	}

	static latin2(str) {
		return Charset::convert(str, UTABLE_ISO8859_2);
	}

	static latin3(str) {
		return Charset::convert(str, UTABLE_ISO8859_3);
	}

	static latin4(str) {
		return Charset::convert(str, UTABLE_ISO8859_4);
	}

	static cyrillic(str) {
		return Charset::convert(str, UTABLE_ISO8859_5);
	}

	static arabic(str) {
		return Charset::convert(str, UTABLE_ISO8859_6);
	}

	static greek(str) {
		return Charset::convert(str, UTABLE_ISO8859_7);
	}

	static hebrew(str) {
		return Charset::convert(str, UTABLE_ISO8859_8);
	}

	static latin5(str) {
		return Charset::convert(str, UTABLE_ISO8859_9);
	}

	static latin6(str) {
		return Charset::convert(str, UTABLE_ISO8859_10);
	}

	static latin10(str) {
		return Charset::convert(str, UTABLE_ISO8859_16);
	}
}
